@page
@model Danplanner.Client.Pages.MapModel
@{
    ViewData["Title"] = "Vælg plads";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .page-top { background:#222; padding:16px; color:#fff; margin-bottom:18px; display:flex; align-items:center; justify-content:space-between; }
    .top-left { font-weight:700; }
    .map-wrapper { display:flex; gap:20px; align-items:flex-start; }
    #map { width: 100%; max-width: 1100px; height: 600px; border: 1px solid #ddd; background:#eee; }
    .map-side { width: 320px; }
    .points-list { list-style:none; padding:0; margin:0; }
    .points-list li { padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
    .points-list li:hover { background:#fafafa; }
    .selected { background:#e9f5ff; }
    .map-legend { font-size:0.9rem; color:#333; margin-bottom:12px; }
    .media (max-width: 991.98px) {
        .map-wrapper { flex-direction:column; }
        #map { height:400px; max-width:100%; }
        .map-side { width:100%; }
    }
</style>

<div class="page-top">
    <div class="top-left">Vælg plads:</div>
    <div class="top-right">
        <div class="accom-dates" style="background:#fff;color:#000;padding:8px 12px;border-radius:6px;">
            <span><strong>Ankomst:</strong> @Model.Start</span>
            <span style="margin-left:12px;"><strong>Afrejse:</strong> @Model.End</span>
        </div>
    </div>
</div>

<div class="map-wrapper">
    <div id="map" aria-label="Kort over campingplads"></div>
    <div class="map-side" aria-hidden="false">
        <div class="map-legend"><strong>Pladser / Hytter</strong></div>
        <select id="points" class="points-dropdown">
    <option value="">Vælg plads...</option>
</select>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // embed server-provided json
    const mapDef = @Html.Raw(Model.FilteredMapJson);
    const startQuery = '@(Model.Start ?? string.Empty)';
    const endQuery = '@(Model.End ?? string.Empty)';
    const preselected = '@(Model.SelectedKey ?? "")';

    // default Leaflet blue marker (use CDN images)
    const defaultIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // initialize leaflet with CRS.Simple so coordinates map to image pixels
    const map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -5,
        maxZoom: 2,
        zoomControl: true,
        attributionControl: false
    });

    // image bounds: top-left (0,0) to bottom-right (height, width)
    const bounds = [[0, 0], [mapDef.Height, mapDef.Width]];
    const image = L.imageOverlay(mapDef.ImageUrl, bounds).addTo(map);

    map.fitBounds(bounds);

    // marker group
    const markers = {};
    const listEl = document.getElementById('points');
        listEl.addEventListener('change', () => {
        if (listEl.value) {
            selectPoint(listEl.value);
        }
    });

    // create icon for a custom image url
    function createIconFromUrl(url) {
        return L.icon({
            iconUrl: url,
            iconSize: [28, 28],
            iconAnchor: [14, 14],
            popupAnchor: [0, -14]
        });
    }

    function selectPoint(key) {
        const m = markers[key];
        if (!m) return;

        // marker valgt option i dropdown
        Array.from(listEl.options).forEach(o => {
            o.selected = (o.value === key);
        });

        m.openPopup();
        map.panTo(m.getLatLng(), { animate: true });
    }

    (function addPoints() {
        (mapDef.Points || []).forEach(point => {
            // Leaflet uses [lat, lng] => [y, x] for CRS.Simple using the same bounds as the image
            const lat = mapDef.Height - point.Y;
            const lng = point.X;
            const latlng = [lat, lng];

            // create marker initially with defaultIcon to avoid broken images
            const marker = L.marker(latlng, { icon: defaultIcon }).addTo(map);

            // if a custom ImageUrl exists, try to load it and replace icon on success
            if (point.ImageUrl) {
                const img = new Image();
                img.onload = function () {
                    try {
                        const custom = createIconFromUrl(point.ImageUrl);
                        marker.setIcon(custom);
                    } catch (e) {
                        // if anything goes wrong, keep defaultIcon
                        console.warn('Failed to set custom icon for', point.Key, e);
                    }
                };
                img.onerror = function () {
                    // keep default icon if image fails to load
                    console.warn('Custom icon failed to load for', point.Key, point.ImageUrl);
                };
                // start loading (cache-bust omitted to allow normal caching)
                img.src = point.ImageUrl;
            }

            const popupHtml = `<div style="min-width:160px">
                <strong>${escapeHtml(point.Title)}</strong>
                <div style="margin-top:6px">${escapeHtml(point.Description || '')}</div>
                <div style="margin-top:8px;text-align:right">
                    <button data-key="${escapeHtml(point.Key)}" class="choose-btn btn-small">Vælg</button>
                </div>
            </div>`;
            marker.bindPopup(popupHtml, { closeButton: true });

                marker.on('popupopen', () => {
                setTimeout(() => {
                    const btn = document.querySelector('.choose-btn[data-key="' + point.Key + '"]');
                    if (btn) {
                        btn.addEventListener('click', () => {
                            const unitId = point.AccommodationId;   // den KONKRETE plads/hytte
                            const placeKey = point.Key;            // fx "Plads 5"

                            const url = `/Confirmation?Start=${encodeURIComponent(startQuery)}&End=${encodeURIComponent(endQuery)}&unitId=${encodeURIComponent(unitId)}&placeKey=${encodeURIComponent(placeKey)}`;
                            window.location.href = url;
                        });
                    }
                }, 10);
            });

            markers[point.Key] = marker;

            // add list item
            const opt = document.createElement('option');
            opt.value = point.Key;
            opt.textContent = point.Title;
            listEl.appendChild(opt);
            });

        // preselect if requested
        if (preselected) {
            setTimeout(() => selectPoint(preselected), 250);
        }
    })();

    // small helper
    function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/[&<>"'`=\/]/g, function (c) { return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '/':'&#x2F;','`':'&#x60;','=':'&#x3D;' })[c]; });
    }
</script>
